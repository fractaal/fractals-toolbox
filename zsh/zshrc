# Prepend fractals-toolbox/bin so wrapper scripts (e.g. qmd serializer)
# shadow their originals on PATH.
export PATH="$HOME/.fractals-toolbox/bin:$PATH"

# Toggle lid sleep by flipping pmset disablesleep.
lidsleep() {
  local current
  current=$(pmset -g | awk '/SleepDisabled/ {print $2; exit}')
  if [[ -z "$current" ]]; then
    current=$(pmset -g custom | awk '/disablesleep/ {print $2; exit}')
  fi

  case "$1" in
    on|enable)
      sudo pmset -a disablesleep 1
      echo "Lid sleep disabled (disablesleep=1)."
      return
      ;;
    off|disable)
      sudo pmset -a disablesleep 0
      echo "Lid sleep enabled (disablesleep=0)."
      return
      ;;
    status)
      if [[ -n "$current" ]]; then
        echo "SleepDisabled=$current"
      else
        echo "SleepDisabled not found in pmset output."
      fi
      return
      ;;
  esac

  if [[ "$current" == "1" ]]; then
    sudo pmset -a disablesleep 0
    echo "Lid sleep enabled (disablesleep=0)."
  else
    sudo pmset -a disablesleep 1
    echo "Lid sleep disabled (disablesleep=1)."
  fi
}

# Kill processes bound to one or more local ports.
portkill() {
  if (( $# == 0 )); then
    echo "Usage: portkill <port> [port ...]" >&2
    return 1
  fi

  if ! command -v lsof >/dev/null 2>&1; then
    echo "lsof is required for portkill." >&2
    return 1
  fi

  local port pid
  local -a invalid_ports ports_without_processes unique_pids killed_pids failed_pids
  local -a port_pids
  local -A seen_pids

  for port in "$@"; do
    if [[ "$port" != <-> || "$port" -lt 1 || "$port" -gt 65535 ]]; then
      invalid_ports+=("$port")
      continue
    fi

    port_pids=("${(@f)$(lsof -ti :"$port" 2>/dev/null)}")
    port_pids=("${(@)port_pids:#}")
    if (( ${#port_pids[@]} == 0 )); then
      ports_without_processes+=("$port")
      continue
    fi

    for pid in "${port_pids[@]}"; do
      if [[ -z "${seen_pids[$pid]-}" ]]; then
        seen_pids[$pid]=1
        unique_pids+=("$pid")
      fi
    done
  done

  if (( ${#invalid_ports[@]} > 0 )); then
    echo "Invalid port value(s): ${(j:, :)invalid_ports}" >&2
  fi

  if (( ${#unique_pids[@]} == 0 )); then
    if (( ${#ports_without_processes[@]} > 0 )); then
      echo "No processes found on port(s): ${(j:, :)ports_without_processes}"
    else
      echo "No killable processes found for the provided ports."
    fi
    return 1
  fi

  for pid in "${unique_pids[@]}"; do
    if kill "$pid" >/dev/null 2>&1; then
      killed_pids+=("$pid")
    else
      failed_pids+=("$pid")
    fi
  done

  if (( ${#ports_without_processes[@]} > 0 )); then
    echo "No processes found on port(s): ${(j:, :)ports_without_processes}"
  fi

  if (( ${#killed_pids[@]} > 0 )); then
    echo "Killed ${#killed_pids[@]} process(es): ${(j:, :)killed_pids}"
  else
    echo "Found process(es), but none could be killed." >&2
  fi

  if (( ${#failed_pids[@]} > 0 )); then
    echo "Failed to kill process(es): ${(j:, :)failed_pids}" >&2
  fi

  (( ${#killed_pids[@]} > 0 ))
}

# Set all Discord processes to lowest priority
renice-discord() {
  local pids=$(ps aux | grep -i discord | grep -v grep | awk '{print $2}')
  if [[ -z "$pids" ]]; then
    echo "No Discord processes found."
    return 1
  fi

  echo "$pids" | xargs -I {} renice -n 20 -p {} 2>/dev/null

  local count=$(echo "$pids" | wc -l | tr -d ' ')
  echo "Set $count Discord processes to niceness 20 (lowest priority)."
}
alias discord-renice='renice-discord'

alias claude="claude --dangerously-skip-permissions"

export NX_NATIVE_FILE_CACHE_DIRECTORY="$HOME/.nx/native-file-cache"
export NX_TUI=false
export NX_SOCKET_DIR=/tmp/nx

if [[ -r "$HOME/.fractals-toolbox/zsh/hosts.zsh" ]]; then
  source "$HOME/.fractals-toolbox/zsh/hosts.zsh"
fi

if [[ -r "$HOME/.fractals-toolbox/zsh/sshtunnel.zsh" ]]; then
  source "$HOME/.fractals-toolbox/zsh/sshtunnel.zsh"
fi

if [[ -r "$HOME/.fractals-toolbox/zsh/sshsend.zsh" ]]; then
  source "$HOME/.fractals-toolbox/zsh/sshsend.zsh"
fi
